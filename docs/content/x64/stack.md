# X64 汇编/栈

栈是内存中的一块特殊区域, 它根据 LIFO(先入后出) 的原理进行工作. 当 Linux 操作系统载入程序时, 栈通常被安置在内存高位, 栈向下生长; 堆则放置在内存低位, 堆向上生长. 寄存器 rsp 用作栈指针, 它总是指向栈中最顶层的元素. 栈是一种数据结构, 用于管理函数调用和局部变量的分配和释放.

- 函数调用: 当一个函数被调用时, 相关的参数和返回地址被推入栈中. 这允许函数在执行完毕后能够返回到正确的位置. 每次函数调用时, 栈指针都会向下移动.
- 局部变量存储: 每当函数需要分配局部变量时, 这些变量将被推入栈中. 这样可以确保每个函数的局部变量在函数执行期间都有自己的存储空间. 当函数执行完毕时, 这些局部变量将从栈中弹出, 释放相应的内存空间.
- 寄存器保存: 当函数被调用时, 一些寄存器的值可能需要保存, 以便在函数执行完毕后能够恢复到调用函数之前的状态. 这些寄存器的值通常会被推入栈中, 并在函数执行完毕后恢复.
- 栈帧: 每个函数调用都会创建一个栈帧, 它包含了函数的参数, 局部变量和其他必要的信息. 栈帧在栈上按顺序排列, 形成了函数调用的堆栈结构.

## 栈操作指令

在 x86 体系结构中, 操作栈主要通过以下两个指令进行:

- PUSH 指令: PUSH 指令用于将数据推入栈中. 它的操作是将指定的数据从寄存器或内存中复制到栈顶, 并将栈指针减小以指向新的栈顶位置. 例如, 要将寄存器 EAX 的值推入栈中, 可以使用以下指令:

```text
push eax
```

- POP 指令: POP 指令用于从栈中弹出数据. 它的操作是将栈顶的数据复制到指定的目标位置(通常是一个寄存器或内存), 然后将栈指针增加以指向新的栈顶位置. 例如, 要从栈中弹出一个值并存储到寄存器 EBX 中, 可以使用以下指令:

```text
pop ebx
```

除了 PUSH 和 POP 指令之外, 还有其他一些与栈相关的指令, 如 LEA(Load Effective Address) 用于将栈中的地址加载到寄存器中, 以便访问栈中的其他元素. 在程序中, 栈的操作通常由编译器或汇编器自动处理, 例如在函数调用和返回时, 参数和局部变量的推入和弹出操作会被自动生成. 但是, 如果你正在编写汇编语言程序, 你可以直接使用 PUSH 和 POP 指令来操作栈.
